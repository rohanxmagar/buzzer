<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Dashboard</title>
    <link rel="shortcut icon" href="bell.png" type="image/x-icon">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            justify-content: center;
        }

        .navbar {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .logout-button {
            float: right;
            margin-right: 20px;
            padding: 8px 16px;
            background: #FF5733;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .buzzer-container {
            text-align: center;
            margin-top: 50px;
        }

        .buzzer-btn {
            padding: 20px 40px;
            font-size: 2rem;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            background-color: #4CAF50;
            color: white;
            transition: background 0.3s;
        }

        .buzzer-btn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        .buzzer-btn:hover:not(:disabled) {
            background-color: #45a049;
        }

        #buzzerStatus {
            margin-top: 20px;
            font-size: 1.2rem;
        }

        #stopwatch {
            font-size: 2rem;
            margin-top: 20px;
            color: #ff4500;
            display: none;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <div class="navbar">
        <span id="teamNameDisplay">Team Dashboard</span>
        <button class="logout-button" onclick="logout()">Logout</button>
    </div>

    <!-- Buzzer Section -->
    <div class="buzzer-container">
        <h1>Press the Buzzer!</h1>
        <button id="buzzer" class="buzzer-btn" onclick="pressBuzzer()" disabled>üîî Buzz!</button>
        <p id="buzzerStatus">Waiting for admin to activate...</p>
        <div id="stopwatch">‚è±Ô∏è 0 ms</div>
    </div>

    <script>
        // ‚úÖ Initialize Socket.io (Local or Deployed Environment)
        const socket = io(
            window.location.hostname === 'localhost'
                ? 'http://localhost:3000'
                : 'https://quickbuzz-dtle.onrender.com'
        );

        // ‚úÖ Fetch Team Data from Session Storage
        const teamName = sessionStorage.getItem('teamName') || "Team_X";
        document.getElementById('teamNameDisplay').textContent = `Team: ${teamName}`;

        // Stopwatch Variables
        let buzzerPressed = false;
        let startTime = 0;
        let stopwatchInterval;

        // ‚è±Ô∏è Start Stopwatch when Buzzer is Active
        function startStopwatch() {
            startTime = performance.now();
            const stopwatch = document.getElementById('stopwatch');
            stopwatch.style.display = 'block';

            stopwatchInterval = setInterval(() => {
                if (!buzzerPressed) {
                    const elapsedTime = performance.now() - startTime;
                    stopwatch.textContent = `‚è±Ô∏è ${Math.floor(elapsedTime)} ms`;
                }
            }, 1);
        }

        // üõéÔ∏è Handle Buzzer Press (Send Directly to Admin via Socket.io)
        function pressBuzzer() {
    if (buzzerPressed) return;

    buzzerPressed = true;
    document.getElementById('buzzer').disabled = true;

    const elapsedTime = Math.floor(performance.now() - startTime); // Get time in milliseconds
    document.getElementById('buzzerStatus').textContent = `‚è≥ Buzzer Pressed at ${elapsedTime} ms! Waiting for admin...`;

    // Send Data to Backend with Properly Formatted Time
    socket.emit('buzzerPressed', { teamName, elapsedTime });

    clearInterval(stopwatchInterval);
}


        // üîÑ Listen for Reset Event from Admin
        socket.on('resetBuzzer', () => {
            buzzerPressed = false;
            document.getElementById('buzzer').disabled = true;
            document.getElementById('buzzerStatus').textContent = 'üîÅ Waiting for admin to activate buzzer!';
            document.getElementById('stopwatch').style.display = 'none';
            clearInterval(stopwatchInterval);
        });

        // üîÑ Listen for Activate Buzzer Event from Admin
        socket.on('activateBuzzer', () => {
            buzzerPressed = false;
            document.getElementById('buzzer').disabled = false;
            document.getElementById('buzzerStatus').textContent = '‚úÖ Ready to buzz!';
            startStopwatch();
        });

        // üîÑ Listen for Deactivate Buzzer Event from Admin
        socket.on('deactivateBuzzer', () => {
            buzzerPressed = true;
            document.getElementById('buzzer').disabled = true;
            document.getElementById('buzzerStatus').textContent = '‚ùå Buzzer Deactivated by Admin!';
            clearInterval(stopwatchInterval);
        });

        // üîí Logout Function
        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
        // üîÑ Listen for leaderboard updates from the server
// üîÑ Listen for leaderboard updates from the server
socket.on("updateLeaderboard", (leaderboard) => {
    console.log("Received Leaderboard Update:", leaderboard); // ‚úÖ Debugging

    // Find the team's position
    const teamEntry = leaderboard.find(entry => entry.teamName === teamName);
    
    if (teamEntry) {
        document.getElementById('buzzerStatus').textContent = `üéâ Your Position: ${teamEntry.position}`;
    }
});
// üîÑ Listen for position update from the server
socket.on("yourPosition", (position) => {
    document.getElementById('buzzerStatus').textContent = `üéâ Your Position: ${position}`;
});


    </script>

</body>

</html>
