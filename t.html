<!-- Define the document type and HTML version -->
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Character encoding for proper text display -->
    <meta charset="UTF-8">
    <!-- Responsive design settings for mobile compatibility -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title of the webpage -->
    <title>Team Dashboard</title>
    <!-- Theme color for browser UI customization -->
    <meta name="theme-color" id="themeColor" content="#1e223f"> 
    <!-- Link to external CSS file -->
    <link rel="stylesheet" href="Team_dash.css">
    <!-- Include Socket.io library for real-time communication -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>

<!-- Background container for styling -->
<div class="background">
    <!-- Navigation bar -->
    <nav class="navbar">
        <!-- Display team name -->
        <div class="teamName" id="teamNameDisplay"></div>
        <!-- Hamburger menu for mobile navigation -->
        <div class="hamburger" id="hamburger">
            <div class="line1"></div>
            <div class="line2"></div>
            <div class="line3"></div>
        </div>
        <!-- Navigation links -->
        <ul class="nav-links" id="navLinks">
            <li><button class="join-button" onclick="logout()">Logout</button></li>
        </ul>
    </nav>

    <!-- Buzzer section -->
    <div class="buzzer-container">
        <div class="buzzer-base">
            <div class="buzzer-button">
                <!-- Clickable metal ring to press the buzzer -->
                <div class="metal-ring" onclick="pressBuzzer()"></div>
            </div>
        </div>
        <h1>Press the <span class="highlight">Buzzer</span>!</h1>
        <p id="buzzerStatus">Waiting to buzz...</p>
        <div id="stopwatch">‚è±Ô∏è 0 ms</div>
    </div>
</div>

<script>
    // ‚úÖ Initialize Socket.io (Local or Deployed Environment)
    const socket = io(
        window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : 'https://quickbuzz-dtle.onrender.com'
    );

    // ‚úÖ Fetch Team Data from Session Storage
    const teamName = sessionStorage.getItem('teamName') || "Team_X";
    document.getElementById('teamNameDisplay').textContent = `Team: ${teamName}`;

    let buzzerPressed = false;
    let startTime = performance.now();
    let currentDisplayedTime = 0;

    // ‚è±Ô∏è Start Stopwatch when Buzzer is Active
    function updateStopwatch() {
        if (!buzzerPressed) {
            currentDisplayedTime = Math.floor(performance.now() - startTime);
            document.getElementById('stopwatch').textContent = `‚è±Ô∏è ${currentDisplayedTime} ms`;
            requestAnimationFrame(updateStopwatch);
        }
    }

    function startStopwatch() {
        startTime = performance.now();
        buzzerPressed = false;
        currentDisplayedTime = 0;
        requestAnimationFrame(updateStopwatch);
    }

    startStopwatch();

    // üõéÔ∏è Handle Buzzer Press (Send Directly to Admin via Socket.io)
    function pressBuzzer() {
        if (buzzerPressed) return;
        buzzerPressed = true;
        const exactTime = currentDisplayedTime;
        document.getElementById('buzzerStatus').textContent = `‚è≥ Buzzer Pressed at ${exactTime} ms!`;
        socket.emit('buzzerPressed', { teamName, timestamp: exactTime });
    }

    // üîÑ Listen for Reset Event from Admin
    socket.on('resetBuzzer', () => {
        buzzerPressed = false;
        document.getElementById('buzzerStatus').textContent = '‚úÖ Ready to buzz!';
        startStopwatch();
    });

    // üîÑ Listen for Activate Buzzer Event from Admin
    socket.on('activateBuzzer', () => {
        buzzerPressed = false;
        document.getElementById('buzzerStatus').textContent = '‚úÖ Ready to buzz!';
        startStopwatch();
    });

    // üîÑ Listen for Deactivate Buzzer Event from Admin
    socket.on('deactivateBuzzer', () => {
        buzzerPressed = true;
        document.getElementById('buzzerStatus').textContent = '‚ùå Buzzer Deactivated by Admin!';
    });

    // üîÑ Listen for leaderboard updates from the server
    socket.on("updateLeaderboard", (leaderboard) => {
        console.log("Received Leaderboard Update:", leaderboard);
        const teamEntry = leaderboard.find(entry => entry.teamName === teamName);
        if (teamEntry) {
            document.getElementById('buzzerStatus').textContent = `üéâ Your Position: ${teamEntry.position}`;
        }
    });

    // üîÑ Listen for position update from the server
    socket.on("yourPosition", (position) => {
        document.getElementById('buzzerStatus').textContent = `üéâ Your Position: ${position}`;
    });

    // üîí Logout Function
    function logout() {
        sessionStorage.clear();
        window.location.href = 'index.html';
    }

    // ‚úÖ Toggle Mobile Menu
    const hamburger = document.getElementById('hamburger');
    const navLinks = document.getElementById('navLinks');

    hamburger.addEventListener('click', () => {
        navLinks.classList.toggle('open');
        hamburger.classList.toggle('toggle');
    });

    function closeMenu() {
        navLinks.classList.remove('open');
        hamburger.classList.remove('toggle');
    }
</script>

</body>
</html>
